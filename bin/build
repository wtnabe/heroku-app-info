#! /bin/bash

ROOT=$(dirname `dirname $0`)

if [ -z $GITHUB_ACTIONS ]; then
  bundle exec rake clean
  bundle exec rake build
  echo "starting webrick server"
  bundle exec ruby -e "
require 'webrick'

Process.daemon(true)

File.open('webrick.pid', 'w') { |f|
  server = WEBrick::HTTPServer.new(
    StartCallback: -> {
      f.puts \$\$
      f.flush
    }
  )
  server.mount('/downloads', WEBrick::HTTPServlet::FileHandler, '$ROOT/pkg')
  server.start
}
"
fi

RUBY_VERSION=3.3.1

if [ -n "$GITHUB_ACTIONS" ]; then
  GEM_HOST=rubygems.org
  CACHE_OPTS="--cache-from type=gha --cache-to type=gha"
else
  GEM_HOST=host.docker.internal
fi

PKG_VERSION=`ruby -r ${ROOT}/lib/heroku_app_info/version.rb -e 'puts HerokuAppInfo::VERSION'`

mkdir -p $ROOT/pkg

docker $BUILDX build -t heroku-app-info \
       $CACHE_OPTS \
       --add-host host.docker.internal:host-gateway \
       --build-arg GEM_HOST=$GEM_HOST \
       --build-arg RUBY_VERSION=$RUBY_VERSION \
       --build-arg PKG_VERSION=$PKG_VERSION \
       -f Dockerfile $ROOT/pkg

if [ -e webrick.pid ]; then
  kill -KILL `cat webrick.pid` && rm webrick.pid
fi
